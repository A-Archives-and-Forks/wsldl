#
#
#Author yuk7(yukx00@gmail.com)
#
#Make rootfs tarball for ArchLinux on WSL
#THIS IS NOT SHELL SCRIPT

#Download ArchLinux bootstrap and modded glibc/fakeroot-tcp packages
wget http://ftp.jaist.ac.jp/pub/Linux/ArchLinux/iso/2017.10.01/archlinux-bootstrap-2017.10.01-x86_64.tar.gz -O archlinux-bootstrap-2017.10.01-x86_64.tar.gz
wget https://github.com/yuk7/arch-prebuilt/releases/download/17101600/glibc-wsl-2.26-4-x86_64.pkg.tar.xz -O glibc-wsl-2.26-4-x86_64.pkg.tar.xz
wget https://github.com/yuk7/arch-prebuilt/releases/download/17101600/fakeroot-tcp-1.21-2-x86_64.pkg.tar.xz -O fakeroot-tcp-1.21-2-x86_64.pkg.tar.xz

#Extract ArchLinux bootstrap tarball. rootfs in root.x86_64 directory
tar -zxvf archlinux-bootstrap-2017.10.01-x86_64.tar.gz

cd root.x86_64

#Resolv.conf for WSL
echo "# This file was automatically generated by WSL. To stop automatic generation of this file, remove this line." >./etc/resolv.conf

#Edit profile for DO NOT RESET PATH
vim ./etc/profile

#Edit MirrorList
vim ./etc/pacman.d/mirrorlist

#Edit pacman.conf Add glibc and fakeroot to IgnorePkg
vim ./etc/pacman.conf

#copy glibc and fakeroot-tcp
cp ../fakeroot-tcp*.pkg.tar.xz ../glibc-wsl*.pkg.tar.xz ./root/


#chroot
arch-chroot .

  #Init pacman and Install&Update some packages
  pacman-key --init
  pacman-key --populate archlinux
  pacman -Syu bzip2 coreutils diffutils gawk gcc-libs gettext grep gzip inetutils iproute2 iputils
  pacman -Syu less man-db man-pages nano sed tar vi vim wget which
 
  #install modded glibc and fakeroot-tcp package
  pacman -U /root/glibc-wsl-2.26-4-x86_64.pkg.tar.xz
  pacman -U /root/fakeroot-tcp-1.21-2-x86_64.pkg.tar.xz
  
  #Remove Package cache
  pacman -Scc
  
  #exit chroot
  exit

#remove unneccesary files
rm -rf ./root/*
rm -rf ./root/.bash_history
rm -rf ./root/.gnupg

#pack rootfs.tar.gz
tar -zcvf ../rootfs.tar.gz *

